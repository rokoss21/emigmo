# Комплексные тесты функции разговоров Enigmo

Этот документ описывает комплексную тестовую suite для проверки функции разговоров в приложении Enigmo.

## Обзор тестов

### 1. Тесты синхронизации состояний звонков (`call_state_synchronization_test.dart`)
**Цель:** Проверка корректности переходов между состояниями звонков
- ✅ Переходы: idle → connecting → connected → ended
- ✅ Синхронизация UI с состоянием WebRTC
- ✅ Обработка быстрого последовательного изменения состояний
- ✅ Корректность сброса состояния после завершения звонка

### 2. Тесты обработки сетевых ошибок (`network_error_handling_test.dart`)
**Цель:** Проверка поведения при сетевых сбоях
- ✅ Автоматическое переподключение при потере связи
- ✅ Обработка максимального количества попыток переподключения
- ✅ Корректное завершение звонка при критических ошибках
- ✅ Управление таймерами переподключения

### 3. Тесты производительности звонков (`call_performance_test.dart`)
**Цель:** Оценка производительности системы
- ✅ Время установки соединения (< 5 секунд)
- ✅ Длительные звонки без потери производительности
- ✅ Быстрая обработка множественных изменений состояния
- ✅ Эффективная очистка ресурсов после звонка

### 4. Интеграционные тесты WebRTC (`webrtc_integration_test.dart`)
**Цель:** Проверка взаимодействия компонентов
- ✅ Полный цикл звонка: вызов → прием → соединение → завершение
- ✅ Обмен ICE кандидатами
- ✅ Функциональность перезапуска соединения
- ✅ Управление аудио во время звонка

### 5. End-to-End тесты звонков (`call_end_to_end_test.dart`)
**Цель:** Полное тестирование пользовательских сценариев
- ✅ Симуляция взаимодействия пользователя с UI
- ✅ Сценарии принятия и отклонения звонков
- ✅ Прерывание и восстановление сети
- ✅ Управление ресурсами приложения

### 6. Серверные интеграционные тесты (`webrtc_server_integration_test.dart`)
**Цель:** Проверка серверной логики обработки звонков
- ✅ Регистрация и аутентификация пользователей
- ✅ Инициирование и прием звонков
- ✅ Обмен сигнальными сообщениями
- ✅ Управление множественными одновременными звонками

## Запуск тестов

### Автоматический запуск всех тестов
```bash
# Из корневой директории проекта
./enigmo/run_call_tests.sh
```

### Ручной запуск отдельных тестов

#### Клиентские тесты (Flutter)
```bash
cd enigmo/enigmo_app
flutter test test/call_state_synchronization_test.dart
flutter test test/network_error_handling_test.dart
flutter test test/call_performance_test.dart
flutter test test/webrtc_integration_test.dart
flutter test test/call_end_to_end_test.dart
```

#### Серверные тесты (Dart)
```bash
cd enigmo/enigmo_server
dart test test/webrtc_server_integration_test.dart
```

## Интерпретация результатов

### Успешные тесты
```
✓ Call State Synchronization Tests PASSED
✓ Network Error Handling Tests PASSED
✓ Call Performance Tests PASSED
✓ WebRTC Integration Tests PASSED
✓ End-to-End Call Tests PASSED
✓ Server Integration Tests PASSED
```

### Неудачные тесты
```
✗ Call State Synchronization Tests FAILED
✗ Network Error Handling Tests FAILED
```

## Метрики производительности

### Целевые показатели
- **Время установки соединения:** < 5 секунд
- **Время обработки ICE кандидата:** < 100 мс
- **Время переподключения:** < 2 секунды
- **Время очистки ресурсов:** < 1 секунда
- **Количество одновременных звонков:** > 10

### Мониторинг производительности
```bash
# Запуск тестов с измерением производительности
flutter test --reporter=json test/call_performance_test.dart
```

## Отладка проблем

### Распространенные проблемы

#### 1. Сетевые проблемы
```
Error: WebSocket connection failed
Solution: Проверьте доступность сервера на порту 8081
```

#### 2. Проблемы с WebRTC
```
Error: Failed to create peer connection
Solution: Проверьте поддержку WebRTC в браузере/устройстве
```

#### 3. Проблемы аутентификации
```
Error: Authentication failed
Solution: Проверьте ключи шифрования и подписи
```

### Логи отладки
```bash
# Включение подробного логирования
export DEBUG_CALLS=true
./enigmo/run_call_tests.sh
```

## Структура тестов

```
enigmo/
├── run_call_tests.sh                 # Скрипт запуска всех тестов
├── CALL_TESTS_README.md             # Этот файл
├── enigmo_app/test/
│   ├── call_state_synchronization_test.dart
│   ├── network_error_handling_test.dart
│   ├── call_performance_test.dart
│   ├── webrtc_integration_test.dart
│   └── call_end_to_end_test.dart
└── enigmo_server/test/
    └── webrtc_server_integration_test.dart
```

## Непрерывная интеграция

### GitHub Actions
```yaml
name: Call Functionality Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v1
      - run: ./enigmo/run_call_tests.sh
```

### Локальная CI
```bash
# Запуск тестов перед коммитом
pre-commit hook: ./enigmo/run_call_tests.sh
```

## Безопасность

### Проверяемые аспекты безопасности
- ✅ End-to-end шифрование
- ✅ Цифровые подписи
- ✅ Аутентификация пользователей
- ✅ Защита от MITM атак
- ✅ Безопасность WebRTC соединений

### Рекомендации по безопасности
1. Регулярно обновляйте ключи шифрования
2. Мониторьте попытки несанкционированного доступа
3. Используйте HTTPS для сигнального сервера
4. Внедрите rate limiting для защиты от DoS атак

## Производительность

### Оптимизации
1. **Сжатие сообщений:** Используйте сжатие для больших объемов данных
2. **Кэширование:** Кэшируйте часто используемые ключи и состояния
3. **Оптимизация WebRTC:** Настройте параметры ICE и DTLS
4. **Мониторинг ресурсов:** Отслеживайте использование памяти и CPU

### Бенчмаркинг
```bash
# Запуск бенчмарков производительности
flutter test --benchmark test/call_performance_test.dart
```

## Поддержка и сопровождение

### Контакты
- **Разработчик:** Команда Enigmo
- **Документация:** [Ссылка на основную документацию]
- **Issues:** [Ссылка на систему отслеживания ошибок]

### Обновление тестов
1. Добавляйте новые тесты для новых функций
2. Обновляйте существующие тесты при изменении API
3. Поддерживайте актуальность mock объектов
4. Регулярно проверяйте метрики производительности

---

**Примечание:** Эти тесты обеспечивают комплексную проверку функции разговоров и должны запускаться перед каждым релизом для обеспечения качества и стабильности системы.